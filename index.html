<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Webã‚¯ãƒ¼ãƒãƒ³ç™ºè¡Œæ©Ÿ</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background-color: #f9f9f9;
      padding: 20px;
    }

    canvas {
      border: 1px solid #ccc;
      max-width: 100%;
      opacity: 0;
      transition: opacity 1s ease-in-out;
    }

    canvas.show {
      opacity: 1;
    }

    button {
      margin-top: 20px;
      padding: 12px 24px;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    button:hover {
      transform: scale(1.05);
    }
  </style>
</head>
<body>
  <h2>ğŸ ã‚¯ãƒ¼ãƒãƒ³ç™ºè¡Œ ğŸ</h2>

  <canvas id="couponCanvas" width="800" height="500"></canvas>
  <br>
  <button onclick="issueCoupon()">ã‚¯ãƒ¼ãƒãƒ³ã‚’ç™ºè¡Œã™ã‚‹</button>
  <br><br>
  <button onclick="downloadCoupon()">ç”»åƒã‚’ä¿å­˜</button>

  <script>
    const canvas = document.getElementById('couponCanvas');
    const ctx = canvas.getContext('2d');

    function generateSerialNumber() {
      const now = new Date();
      const yyyymmdd = now.toISOString().slice(0, 10).replace(/-/g, '');
      const random = Math.random().toString(36).substring(2, 6).toUpperCase(); // ä¾‹: A3F9
      return `C${yyyymmdd}-${random}`;
    }

    function drawCouponCanvas(serial, expireDate) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // èƒŒæ™¯
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // è¦‹å‡ºã—
      ctx.fillStyle = "#000000";
      ctx.font = "bold 36px sans-serif";
      ctx.fillText("ğŸ 500å††å‰²å¼•ã‚¯ãƒ¼ãƒãƒ³ ğŸ", 200, 100);

      // ç®¡ç†ç•ªå·ï¼ˆå·¦ä¸Šï¼‰
      ctx.font = "20px sans-serif";
      ctx.fillText(`ç®¡ç†ç•ªå· : ${serial}`, 20, 40);

      // æœ‰åŠ¹æœŸé™ï¼ˆä¸­å¤®ä¸‹ï¼‰
      const dateParts = expireDate.split("-");
      const expiryText = `æœ‰åŠ¹æœŸé™ : ${dateParts[0]}å¹´ ${parseInt(dateParts[1])}æœˆ ${parseInt(dateParts[2])}æ—¥`;
      ctx.font = "24px sans-serif";
      ctx.fillText(expiryText, 220, 400);
    }

    function issueCoupon() {
      const serial = generateSerialNumber();

      const today = new Date();
      const issueDate = today.toISOString().split("T")[0];

      const expiry = new Date(today);
      expiry.setDate(today.getDate() + 90);
      const expireDate = expiry.toISOString().split("T")[0];

      fetch("https://script.google.com/macros/s/AKfycbxiUvN5MlY4vM9-leao0POEz1gFUauYPYMoiskg2Ep2ZIugGJ_m2tqox4Y4rsc0PeZi_w/exec", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          serial: serial,
          discount: "500å††å‰²å¼•",
          issueDate: issueDate,
          expireDate: expireDate
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.result === "success") {
          drawCouponCanvas(serial, expireDate);
          canvas.classList.add("show");
        } else {
          alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
      })
      .catch(err => {
        console.error("é€šä¿¡ã‚¨ãƒ©ãƒ¼:", err);
        alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
      });
    }

    function downloadCoupon() {
      const image = canvas.toDataURL("image/png");
      const link = document.createElement('a');
      link.download = 'coupon.png';
      link.href = image;
      link.click();
    }
  </script>
</body>
</html>
